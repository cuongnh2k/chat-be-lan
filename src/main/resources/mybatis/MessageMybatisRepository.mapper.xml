<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="MessageMybatisRepository">

    <select id="countListMessage" parameterType="website.chatx.dto.prt.message.GetListMessagePrt"
            resultType="java.lang.Long">
        /* MessageMybatisRepository.countListMessage */
        select count(1)
        from message m1
            join channel c1
                on (m1.channel_id = c1.id
                    and c1.id = #{channelId}
        <if test="content != ''">
            <bind name="pattern" value="'%' + content + '%'"/>
                    and m1.content like #{pattern}
        </if>
        )
            join user_channel uc1 on (c1.id = uc1.channel_id and uc1.user_id = #{userId} and uc1.status = 'ACCEPT')
    </select>

    <select id="getListMessage" parameterType="website.chatx.dto.prt.message.GetListMessagePrt"
            resultMap="getListMessageResultMap">
        /* MessageMybatisRepository.getListMessage */
        select  m1.id               id,
                m1.content          content,
                m1.created_at       createdAt,
                m1.updated_at       updatedAt,

                u1.id               senderId,
                u1.email            senderEmail,
                u1.name             senderName,
                u1.avatar_url       senderAvatarUrl,

                mf1.name            messageFileName,
                mf1.url             messageFileUrl,
                mf1.content_type    messageFileContentType,
                mf1.size            messageFileSize,
                mf1.created_at      messageFileCreatedAt,
                mf1.updated_at      messageFileUpdatedAt
        from message m1
                 join channel c1
                      on (m1.channel_id = c1.id
                          and c1.id = #{channelId}
        <if test="content != ''">
            <bind name="pattern" value="'%' + content + '%'"/>
            and m1.content like #{pattern}
        </if>
                          )
                 join user_channel uc1 on (c1.id = uc1.channel_id and uc1.user_id = #{userId} and uc1.status = 'ACCEPT')
                 left join user u1 on (m1.sender_id = u1.id)
                 left join message_file mf1 on (m1.id = mf1.message_id)
        order by m1.created_at desc
        limit #{offset}, #{limit}
    </select>

    <resultMap id="getListMessageResultMap" type="website.chatx.dto.rss.message.list.ListMessageRss">
        <result property="id" column="id"/>
        <result property="content" column="content"/>
        <result property="createdAt" column="createdAt"/>
        <result property="updatedAt" column="updatedAt"/>
        <result property="senderId" column="senderId"/>
        <result property="senderEmail" column="senderEmail"/>
        <result property="senderName" column="senderName"/>
        <result property="senderAvatarUrl" column="senderAvatarUrl"/>
        <collection property="listMessageFile" ofType="website.chatx.dto.rss.message.list.ListMessageFileRss">
            <result property="messageFileName" column="messageFileName"/>
            <result property="messageFileUrl" column="messageFileUrl"/>
            <result property="messageFileContentType" column="messageFileContentType"/>
            <result property="messageFileSize" column="messageFileSize"/>
            <result property="messageFileCreatedAt" column="messageFileCreatedAt"/>
            <result property="messageFileUpdatedAt" column="messageFileUpdatedAt"/>
        </collection>
    </resultMap>

</mapper>
